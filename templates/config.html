{% extends "base.html" %} {% block content %}
<div id="config-container">
  <div class="card mb-4">
    <div class="card-header bg-primary text-white">
      <h1 class="h4 mb-0">
        <i class="fas fa-cog me-2"></i>
        Beets Configuration
      </h1>
    </div>
    <div class="card-body">
      <div class="alert alert-info mb-4">
        <i class="fas fa-info-circle me-2"></i>
        Manage your beets configuration, view installed plugins, and check
        configuration status.
      </div>

      <!-- Status Section -->
      <div class="card bg-light mb-4">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-info-circle me-2"></i>
            Status
          </h5>
        </div>
        <div class="card-body">
          <div id="config-status-panel">
            {% if config_status %}
            <div
              class="alert {% if config_status.beets_installed and config_status.config_exists and config_status.db_exists %}alert-success{% else %}alert-warning{% endif %}"
            >
              <i
                class="fas fa-{% if config_status.beets_installed and config_status.config_exists and config_status.db_exists %}check{% else %}exclamation{% endif %}-circle me-2"
              ></i>
              {% if config_status.beets_installed and
              config_status.config_exists and config_status.db_exists %} Beets
              is installed and configured correctly. {% else %} Beets
              configuration requires attention. {% endif %}
            </div>
            <ul class="list-group">
              <li
                class="list-group-item {% if config_status.beets_installed %}list-group-item-success{% else %}list-group-item-danger{% endif %}"
              >
                <i
                  class="fas fa-{% if config_status.beets_installed %}check{% else %}times{% endif %}-circle me-2"
                ></i>
                Beets Installed: {% if config_status.beets_installed %}Yes{%
                else %}No{% endif %}
              </li>
              <li
                class="list-group-item {% if config_status.config_exists %}list-group-item-success{% else %}list-group-item-warning{% endif %}"
              >
                <i
                  class="fas fa-{% if config_status.config_exists %}check{% else %}exclamation{% endif %}-circle me-2"
                ></i>
                Config File: {% if config_status.config_exists %}Found{% else
                %}Not Found{% endif %}
                <small class="text-muted d-block"
                  >{{ config_status.config_path }}</small
                >
              </li>
              <li
                class="list-group-item {% if config_status.db_exists %}list-group-item-success{% else %}list-group-item-warning{% endif %}"
              >
                <i
                  class="fas fa-{% if config_status.db_exists %}check{% else %}exclamation{% endif %}-circle me-2"
                ></i>
                Database File: {% if config_status.db_exists %}Found{% else
                %}Not Found{% endif %}
                <small class="text-muted d-block"
                  >{{ config_status.db_path }}</small
                >
              </li>
            </ul>
            {% else %}
            <div class="alert alert-warning">
              <i class="fas fa-exclamation-circle me-2"></i>
              Unable to retrieve configuration status.
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Configuration Tabs -->
      <ul class="nav nav-tabs mb-3" id="configTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button
            class="nav-link active"
            id="config-tab"
            data-bs-toggle="tab"
            data-bs-target="#config-panel"
            type="button"
            role="tab"
          >
            <i class="fas fa-sliders-h me-1"></i> Configuration
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="plugins-tab"
            data-bs-toggle="tab"
            data-bs-target="#plugins-panel"
            type="button"
            role="tab"
          >
            <i class="fas fa-puzzle-piece me-1"></i> Plugins
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="advanced-tab"
            data-bs-toggle="tab"
            data-bs-target="#advanced-panel"
            type="button"
            role="tab"
          >
            <i class="fas fa-cogs me-1"></i> Advanced
          </button>
        </li>
      </ul>

      <div class="tab-content" id="configTabContent">
        <!-- Configuration Panel -->
        <div
          class="tab-pane fade show active"
          id="config-panel"
          role="tabpanel"
          aria-labelledby="config-tab"
        >
          <div class="card bg-light">
            <div class="card-body">
              <form id="config-form">
                <div class="mb-3">
                  <label for="config-directory" class="form-label"
                    >Music Directory</label
                  >
                  <div class="input-group">
                    <span class="input-group-text"
                      ><i class="fas fa-folder"></i
                    ></span>
                    <input
                      type="text"
                      class="form-control"
                      id="config-directory"
                      placeholder="/music"
                    />
                  </div>
                  <div class="form-text">
                    The root directory of your music collection.
                  </div>
                </div>

                <div class="mb-3">
                  <label for="config-library" class="form-label"
                    >Library File Path</label
                  >
                  <div class="input-group">
                    <span class="input-group-text"
                      ><i class="fas fa-database"></i
                    ></span>
                    <input
                      type="text"
                      class="form-control"
                      id="config-library"
                      placeholder="/root/.config/beets/library.db"
                      readonly
                    />
                  </div>
                  <div class="form-text">
                    Location of the beets database file (read-only).
                  </div>
                </div>

                <div class="mb-3">
                  <label for="config-import-copy" class="form-check-label"
                    >Import Settings</label
                  >
                  <div class="form-check mt-2">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="config-import-copy"
                    />
                    <label class="form-check-label" for="config-import-copy">
                      Copy files to music directory on import
                    </label>
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="config-import-move"
                    />
                    <label class="form-check-label" for="config-import-move">
                      Move files to music directory on import
                    </label>
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="config-import-write"
                    />
                    <label class="form-check-label" for="config-import-write">
                      Write metadata to files on import
                    </label>
                  </div>
                </div>

                <div class="mb-3">
                  <label for="config-path-format" class="form-label"
                    >Path Format</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="config-path-format"
                    placeholder="$albumartist/$album%aunique{}/$track $title"
                  />
                  <div class="form-text">
                    The format used for naming and organizing music files.
                  </div>
                </div>

                <div class="mb-3 d-grid gap-2 d-md-flex justify-content-md-end">
                  <button
                    type="button"
                    id="config-reset-btn"
                    class="btn btn-secondary"
                  >
                    <i class="fas fa-sync-alt me-1"></i> Reset
                  </button>
                  <button
                    type="submit"
                    id="config-save-btn"
                    class="btn btn-primary"
                  >
                    <i class="fas fa-save me-1"></i> Save
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- Plugins Panel -->
        <div
          class="tab-pane fade"
          id="plugins-panel"
          role="tabpanel"
          aria-labelledby="plugins-tab"
        >
          <div class="card bg-light">
            <div class="card-body">
              <div id="plugins-list">
                {% if plugins_info and plugins_info.success %}
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th>Plugin</th>
                        <th>Description</th>
                        <th>Status</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for plugin in plugins_info.plugins %}
                      <tr>
                        <td><strong>{{ plugin.name }}</strong></td>
                        <td>{{ plugin.description }}</td>
                        <td>
                          <div class="form-check form-switch">
                            <input
                              class="form-check-input plugin-toggle"
                              type="checkbox"
                              id="plugin-{{ plugin.name }}"
                              data-plugin-name="{{ plugin.name }}"
                            />
                          </div>
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
                {% else %}
                <div class="alert alert-warning">
                  <i class="fas fa-exclamation-circle me-2"></i>
                  Unable to retrieve plugin information.
                </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <!-- Advanced Panel -->
        <div
          class="tab-pane fade"
          id="advanced-panel"
          role="tabpanel"
          aria-labelledby="advanced-tab"
        >
          <div class="card bg-light">
            <div class="card-body">
              <h5 class="card-title">Raw Configuration</h5>
              <p class="card-text">
                Edit your beets configuration directly in YAML format.
              </p>
              <div class="mb-3">
                <textarea
                  class="form-control font-monospace"
                  id="raw-config"
                  rows="15"
                ></textarea>
              </div>
              <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <button
                  type="button"
                  id="raw-config-reload-btn"
                  class="btn btn-secondary"
                >
                  <i class="fas fa-sync-alt me-1"></i> Reload
                </button>
                <button
                  type="button"
                  id="raw-config-save-btn"
                  class="btn btn-primary"
                >
                  <i class="fas fa-save me-1"></i> Save
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Initial load of configuration
    loadBeetsConfig();

    // Set up event listeners
    document
      .getElementById("config-form")
      .addEventListener("submit", function (e) {
        e.preventDefault();
        saveBeetsConfig();
      });

    document
      .getElementById("config-reset-btn")
      .addEventListener("click", function () {
        loadBeetsConfig();
      });

    // Plugin toggle events
    const pluginToggles = document.querySelectorAll(".plugin-toggle");
    pluginToggles.forEach((toggle) => {
      toggle.addEventListener("change", function () {
        togglePlugin(this.dataset.pluginName, this.checked);
      });
    });

    // Raw config
    document
      .getElementById("raw-config-reload-btn")
      .addEventListener("click", function () {
        loadRawConfig();
      });

    document
      .getElementById("raw-config-save-btn")
      .addEventListener("click", function () {
        saveRawConfig();
      });

    // Load raw config initially
    loadRawConfig();
  });

  // Load beets configuration
  function loadBeetsConfig() {
    fetch("/api/beets/config")
      .then((response) => {
        if (!response.ok) {
          throw new Error("Failed to fetch beets configuration");
        }
        return response.json();
      })
      .then((config) => {
        // Fill in the form with config values
        if (config.directory) {
          document.getElementById("config-directory").value = config.directory;
        }

        if (config.library) {
          document.getElementById("config-library").value = config.library;
        }

        if (config.import) {
          document.getElementById("config-import-copy").checked =
            config.import.copy === true;
          document.getElementById("config-import-move").checked =
            config.import.move === true;
          document.getElementById("config-import-write").checked =
            config.import.write === true;
        }

        if (config.paths && config.paths.default) {
          document.getElementById("config-path-format").value =
            config.paths.default;
        }

        // Update plugin toggles
        if (config.plugins) {
          const plugins = Array.isArray(config.plugins) ? config.plugins : [];

          // Check corresponding plugin toggles
          document.querySelectorAll(".plugin-toggle").forEach((toggle) => {
            const pluginName = toggle.dataset.pluginName;
            toggle.checked = plugins.includes(pluginName);
          });
        }
      })
      .catch((error) => {
        console.error("Error loading beets config:", error);
        showError("Failed to load configuration: " + error.message);
      });
  }

  // Save beets configuration
  function saveBeetsConfig() {
    const directory = document.getElementById("config-directory").value;
    const importCopy = document.getElementById("config-import-copy").checked;
    const importMove = document.getElementById("config-import-move").checked;
    const importWrite = document.getElementById("config-import-write").checked;
    const pathFormat = document.getElementById("config-path-format").value;

    // Build config object
    const config = {
      directory: directory,
      import: {
        copy: importCopy,
        move: importMove,
        write: importWrite,
      },
    };

    // Add path format if provided
    if (pathFormat) {
      config.paths = {
        default: pathFormat,
      };
    }

    // Send updated config
    fetch("/api/beets/config", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(config),
    })
      .then((response) => {
        if (!response.ok) {
          throw new Error("Failed to update configuration");
        }
        return response.json();
      })
      .then((result) => {
        if (result.success) {
          showSuccess("Configuration updated successfully");
        } else {
          showError(
            "Failed to update configuration: " +
              (result.error || "Unknown error")
          );
        }
      })
      .catch((error) => {
        console.error("Error saving config:", error);
        showError("Failed to save configuration: " + error.message);
      });
  }

  // Toggle a plugin on or off
  function togglePlugin(pluginName, enabled) {
    // First get current config
    fetch("/api/beets/config")
      .then((response) => {
        if (!response.ok) {
          throw new Error("Failed to fetch current configuration");
        }
        return response.json();
      })
      .then((config) => {
        // Ensure plugins array exists
        if (!config.plugins) {
          config.plugins = [];
        }

        // Convert to array if it's not already
        if (!Array.isArray(config.plugins)) {
          config.plugins = [config.plugins];
        }

        // Add or remove the plugin
        if (enabled && !config.plugins.includes(pluginName)) {
          config.plugins.push(pluginName);
        } else if (!enabled && config.plugins.includes(pluginName)) {
          config.plugins = config.plugins.filter((p) => p !== pluginName);
        }

        // Update the configuration
        return fetch("/api/beets/config", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ plugins: config.plugins }),
        });
      })
      .then((response) => {
        if (!response.ok) {
          throw new Error("Failed to update plugins");
        }
        return response.json();
      })
      .then((result) => {
        if (result.success) {
          showSuccess(
            `Plugin ${pluginName} ${
              enabled ? "enabled" : "disabled"
            } successfully`
          );
        } else {
          showError(
            "Failed to update plugin: " + (result.error || "Unknown error")
          );
          // Reset the toggle to its previous state
          const toggle = document.getElementById(`plugin-${pluginName}`);
          if (toggle) {
            toggle.checked = !enabled;
          }
        }
      })
      .catch((error) => {
        console.error("Error toggling plugin:", error);
        showError("Failed to toggle plugin: " + error.message);
        // Reset the toggle to its previous state
        const toggle = document.getElementById(`plugin-${pluginName}`);
        if (toggle) {
          toggle.checked = !enabled;
        }
      });
  }

  // Load raw config
  function loadRawConfig() {
    fetch("/api/beets/config")
      .then((response) => {
        if (!response.ok) {
          throw new Error("Failed to fetch raw configuration");
        }
        return response.json();
      })
      .then((config) => {
        // Convert to YAML-like string for display
        let yamlString = "";
        for (const [key, value] of Object.entries(config)) {
          yamlString += formatYamlEntry(key, value, 0);
        }

        document.getElementById("raw-config").value = yamlString;
      })
      .catch((error) => {
        console.error("Error loading raw config:", error);
        showError("Failed to load raw configuration: " + error.message);
      });
  }

  // Save raw config
  function saveRawConfig() {
    const rawText = document.getElementById("raw-config").value;

    try {
      // This is a simplified approach - in a real app, you'd use a proper YAML parser
      // For now, we'll directly send the text to the backend and let it handle parsing
      fetch("/api/beets/config", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ raw_yaml: rawText }),
      })
        .then((response) => {
          if (!response.ok) {
            throw new Error("Failed to update raw configuration");
          }
          return response.json();
        })
        .then((result) => {
          if (result.success) {
            showSuccess("Configuration updated successfully");
            // Reload all config views
            loadBeetsConfig();
            loadRawConfig();
          } else {
            showError(
              "Failed to update configuration: " +
                (result.error || "Unknown error")
            );
          }
        })
        .catch((error) => {
          console.error("Error saving raw config:", error);
          showError("Failed to save configuration: " + error.message);
        });
    } catch (error) {
      console.error("Error parsing YAML:", error);
      showError("Invalid YAML format: " + error.message);
    }
  }

  // Helper for formatting config object as YAML-like string
  function formatYamlEntry(key, value, indent = 0) {
    const indentStr = " ".repeat(indent);
    let result = "";

    if (value === null || value === undefined) {
      result = `${indentStr}${key}:\n`;
    } else if (typeof value === "object" && !Array.isArray(value)) {
      result = `${indentStr}${key}:\n`;
      for (const [k, v] of Object.entries(value)) {
        result += formatYamlEntry(k, v, indent + 2);
      }
    } else if (Array.isArray(value)) {
      result = `${indentStr}${key}:\n`;
      for (const item of value) {
        if (typeof item === "object") {
          result += `${indentStr}- \n`;
          for (const [k, v] of Object.entries(item)) {
            result += formatYamlEntry(k, v, indent + 4);
          }
        } else {
          result += `${indentStr}- ${item}\n`;
        }
      }
    } else {
      result = `${indentStr}${key}: ${value}\n`;
    }

    return result;
  }

  // Show a success notification
  function showSuccess(message) {
    const toast = document.getElementById("successToast");
    const toastBody = document.getElementById("successToastBody");

    if (toast && toastBody) {
      toastBody.textContent = message;
      const bsToast = new bootstrap.Toast(toast);
      bsToast.show();
    }
  }

  // Show an error notification
  function showError(message) {
    const toast = document.getElementById("errorToast");
    const toastBody = document.getElementById("errorToastBody");

    if (toast && toastBody) {
      toastBody.textContent = message;
      const bsToast = new bootstrap.Toast(toast);
      bsToast.show();
    }
  }
</script>
{% endblock %}
